var ghosts={leveldata:[],levelindex:0,attempts:1,loadJS:function(A){var B=document.createElement("script");B.setAttribute("type","text/javascript");B.setAttribute("src",A);document.getElementsByTagName("head")[0].appendChild(B)}};var Enemy=enchant.Class.create(enchant.Sprite,{lightMap:null,initialize:function(A,C,B,D){Sprite.call(this,A,C);this.lightMap=B;this.visible=false;this.addEventListener(Event.ENTER_FRAME,function(H){var G=this.lightMap.getPixel(this.x,this.y);if(G[0]>0){this.visible=true;var F=this.x-D.x+1;var E=this.y-D.y+1;if(Math.abs(F)>Math.abs(E)||E==0){if(F>0){this.x-=1}else{if(F<0){this.x+=1}}}else{if(E>0){this.y-=1}else{if(E<0){this.y+=1}}}if(this.x==D.x&&this.y==D.y){}}else{this.visible=false}});this.addEventListener(Event.REMOVED,function(){this.clearEventListener(Event.REMOVED);this.clearEventListener(Event.ENTER_FRAME)})}});var GameScene=enchant.Class.create(enchant.Scene,{accelX:0,accelY:0,mapData:null,scale:1,initialize:function(){Scene.call(this);var M=Core.instance;this.backgroundColor="#000000";this._bindInputListeners();var E=ghosts.levelindex;this._buildMapData(E);var B=ghosts.leveldata[E].data;var K=12;var N=0;var H=new Sprite(M.width,M.height);var F=new Sprite(M.width,M.height);var D=new Surface(M.width,M.height);var A=new Surface(M.width,M.height);H.image=D;F.image=A;this.addChild(F);this.addChild(H);var C=new Sprite(3,3);C.image=M.assets["assets/exit.png"];C.originX=1;C.originY=1;C.x=Math.floor(B.exit[0]/this.scale);C.y=Math.floor(B.exit[1]/this.scale);C.visible=false;this.addChild(C);var L=new Sprite(1,1);L.x=Math.floor(B.start[0]/this.scale);L.y=Math.floor(B.start[1]/this.scale);L.backgroundColor="#ffff66";this.addChild(L);for(var I=0,J=B.ghosts.length;I<J;I++){var G=new Enemy(3,3,D,L);G.image=M.assets["assets/ghost.png"];G.x=Math.floor(B.ghosts[I][0]/this.scale);G.y=Math.floor(B.ghosts[I][1]/this.scale);this.addChild(G)}this.addEventListener(Event.ENTER_FRAME,function(P){N+=P.elapsed;if(N>2000){K=Math.min(42,K+1);N-=2000}var O=A.context;O.save();O.globalCompositeOperation="destination-out";O.fillStyle="rgba(0, 0, 0, .05)";O.fillRect(0,0,M.width,M.height);O.restore();var R=L.x;var Q=L.y;if(this.accelX!=0){R=Math.min(M.width,Math.max(0,R+this.accelX))}if(this.accelY!=0){Q=Math.min(M.height,Math.max(0,Q+this.accelY))}var S=this.mapData[R*this.scale][Q*this.scale];if(S>0){L.x=R;L.y=Q}D.clear();this._calcLight(L.x,L.y,K,D,A);var S=D.getPixel(C.x,C.y);if(S[0]>0){C.visible=true;if(Math.abs(L.x-C.x-1)<=1&&Math.abs(L.y-C.y-1)<=1){this.clearEventListener(Event.ENTER_FRAME);if(ghosts.levelindex+1==ghosts.leveldata.length){M.replaceScene(new EndScene())}else{M.replaceScene(new WellDoneScene())}}}else{C.visible=false}});this.addEventListener(Event.EXIT,function(){this.clearEventListener(Event.UP_BUTTON_DOWN);this.clearEventListener(Event.DOWN_BUTTON_DOWN);this.clearEventListener(Event.LEFT_BUTTON_DOWN);this.clearEventListener(Event.RIGHT_BUTTON_DOWN);this.clearEventListener(Event.UP_BUTTON_UP);this.clearEventListener(Event.DOWN_BUTTON_UP);this.clearEventListener(Event.LEFT_BUTTON_UP);this.clearEventListener(Event.RIGHT_BUTTON_UP);for(var O in this.childNodes){this.removeChild(this.childNodes[O])}})},_buildMapData:function(D){this.mapData=[];var H=Core.instance.assets[ghosts.leveldata[D].name];var F=1/ghosts.leveldata[D].data.scale;var A=new Surface(H.width,H.height);A.draw(H);var C=A.context.getImageData(0,0,A.width,A.height);for(var I=0;I<C.width;I++){this.mapData.push([]);for(var G=0;G<C.height;G++){var B=(G*C.width+I)*4;var E=((C.data[B]<<16)|(C.data[B+1]<<8)|(C.data[B+2]))*F;this.mapData[I][G]=E}}this.scale=C.width/Core.instance.width},_bindInputListeners:function(){this.addEventListener(Event.UP_BUTTON_DOWN,function(){this.accelY=-1});this.addEventListener(Event.DOWN_BUTTON_DOWN,function(){this.accelY=1});this.addEventListener(Event.LEFT_BUTTON_DOWN,function(){this.accelX=-1});this.addEventListener(Event.RIGHT_BUTTON_DOWN,function(){this.accelX=1});this.addEventListener(Event.UP_BUTTON_UP,function(){this.accelY=0});this.addEventListener(Event.DOWN_BUTTON_UP,function(){this.accelY=0});this.addEventListener(Event.LEFT_BUTTON_UP,function(){this.accelX=0});this.addEventListener(Event.RIGHT_BUTTON_UP,function(){this.accelX=0})},_calcLight:function(M,L,R,f,d){var W=Math.max(0,M-R);var B=Math.max(0,L-R);var U=Math.min(f.width,M+R);var A=Math.min(f.height,L+R);var e=this.mapData;var J=R*R;var T=f.context.getImageData(0,0,f.width,f.height);var Q=this.scale;var D=0;for(var V=B;V<A;++V){for(var O=W;O<U;++O){var F=O-M;var C=V-L;if(F*F+C*C>J){continue}var X=e[O*Q][V*Q];if((O==M&&V==L)){D=(V*T.width+O)*4;T.data[D]=255;T.data[D+1]=255;T.data[D+2]=255;T.data[D+3]=255;continue}var G=(M-O)*Q;var E=(L-V)*Q;var S=G*G+E*E;var K=Math.sqrt(S);G/=K;E/=K;var H=0;var I=X==0?3*Q:X;var b=O*Q;var Y=V*Q;do{if(I==0){break}H=I;b+=H*G;Y+=H*E;var P=b-O*Q;var N=Y-V*Q;if(P*P+N*N>S){D=(V*T.width+O)*4;var Z=1-(1/R*(K/Q));if(X==0){d.setPixel(O,V,127,127,127,255)}T.data[D]=255;T.data[D+1]=255;T.data[D+2]=255;T.data[D+3]=Z*255;break}I=e[Math.round(b)][Math.round(Y)]}while(H>0)}}f.context.putImageData(T,0,0)}});var IntroScene=enchant.Class.create(enchant.Scene,{initialize:function(){Scene.call(this);var B=Core.instance;var D=new Sprite(B.width,B.height);var E=["assets/intro-1.png","assets/intro-2.png","assets/intro-3.png"];var A=0;D.image=B.assets[E[A]];this.addChild(D);var C=0;this.addEventListener(Event.ENTER_FRAME,function(F){C+=F.elapsed;if(C>=4000){A=(A+1)%E.length;D.image=B.assets[E[A]];C-=4000}});this.addEventListener(Event.INPUT_START,function(F){this.clearEventListener(Event.INPUT_START);this.clearEventListener(Event.ENTER_FRAME);B.replaceScene(new GameScene())})}});var WellDoneScene=enchant.Class.create(enchant.Scene,{initialize:function(){Scene.call(this);var A=Core.instance;var B=new Sprite(A.width,A.height);B.image=A.assets["assets/welldone.png"];this.addChild(B);this.addEventListener(Event.INPUT_START,function(C){this.clearEventListener(Event.INPUT_START);A.replaceScene(new GameScene())})}});var EndScene=enchant.Class.create(enchant.Scene,{initialize:function(){Scene.call(this);var I=Core.instance;var E=new Sprite(I.width,I.height);E.image=I.assets["assets/end.png"];this.addChild(E);var C=69;var A=29;var H=ghosts.attempts.toString();for(var F=0,G=H.length;F<G;F++){var D=H.charAt(F);var B=new Sprite(5,5);B.image=I.assets["assets/numbers.png"];B.frame=parseInt(D);B.x=C;B.y=A;C+=6;this.addChild(B)}this.addEventListener(Event.INPUT_START,function(J){this.clearEventListener(Event.INPUT_START);I.replaceScene(new IntroScene())})}});var ldata=ghosts.leveldata||[];ldata.push({name:"assets/levelmap/test.png",data:{start:[13,20],ghosts:[[64,64],[180,83],[22,118],[107,121]],exit:[94,9],scale:140985}});enchant();window.onload=function(){var B=new Core(98,64);B.fps=12;B.scale=4;var D=["assets/died.png","assets/end.png","assets/exit.png","assets/ghost.png","assets/intro-1.png","assets/intro-2.png","assets/intro-3.png","assets/numbers.png","assets/welldone.png"];for(var C=0,A=ghosts.leveldata.length;C<A;C++){D.push(ghosts.leveldata[C].name)}B.preload(D);B.addEventListener(enchant.Event.LOAD,function(){var E=new IntroScene();B.pushScene(E)});B.start();window.scrollTo(0,0)};