var ghosts={assets:["assets/died.png","assets/end.png","assets/end-2.png","assets/exit.png","assets/ghost.png","assets/intro-1.png","assets/intro-2.png","assets/intro-3.png","assets/numbers.png","assets/welldone.png"],leveldata:[],levelindex:0,attempts:1,musicReady:false,useOgg:navigator.userAgent.toLowerCase().match(/(firefox|opera)/)!=null,loadJS:function(A){var B=document.createElement("script");B.setAttribute("type","text/javascript");B.setAttribute("src",A);document.getElementsByTagName("head")[0].appendChild(B)}};var Enemy=enchant.Class.create(enchant.Sprite,{lightMap:null,sound:null,initialize:function(A,D,C,E){Sprite.call(this,A,D);this.lightMap=C;this.visible=false;this.sound=Core.instance.assets["assets/scream"+(ghosts.useOgg?".ogg":".mp3")];var B=false;this.addEventListener(Event.ENTER_FRAME,function(I){var H=this.lightMap.getPixel(this.x,this.y);if(H[0]>0){this.visible=true;if(!B){this.sound.play();B=true}var G=this.x-E.x+1;var F=this.y-E.y+1;if(Math.abs(G)>Math.abs(F)||F==0){if(G>0){this.x-=1}else{if(G<0){this.x+=1}}}else{if(F>0){this.y-=1}else{if(F<0){this.y+=1}}}if(Math.abs(this.x-E.x+1)<=1&&Math.abs(this.y-E.y+1)<=1){Core.instance.replaceScene(new FailScene())}}else{this.visible=false;B=false}});this.addEventListener(Event.REMOVED,function(){this.clearEventListener(Event.REMOVED);this.clearEventListener(Event.ENTER_FRAME)})}});var FailScene=enchant.Class.create(enchant.Scene,{initialize:function(){Scene.call(this);var A=Core.instance;var B=new Sprite(A.width,A.height);B.image=A.assets["assets/died.png"];this.addChild(B);ghosts.attempts++;this.addEventListener(Event.INPUT_START,function(C){this.clearEventListener(Event.INPUT_START);A.replaceScene(new GameScene())})}});var GameScene=enchant.Class.create(enchant.Scene,{accelX:0,accelY:0,mapData:null,scale:1,initialize:function(){Scene.call(this);var N=Core.instance;this.backgroundColor="#000000";this._bindInputListeners();var F=ghosts.levelindex;this._buildMapData(F);var B=ghosts.leveldata[F].data;var L=12;var O=0;var I=new Sprite(N.width,N.height);var G=new Sprite(N.width,N.height);var E=new Surface(N.width,N.height);var A=new Surface(N.width,N.height);I.image=E;G.image=A;this.addChild(G);this.addChild(I);var D=new Sprite(3,3);D.image=N.assets["assets/exit.png"];D.originX=1;D.originY=1;D.x=Math.floor(B.exit[0]/this.scale);D.y=Math.floor(B.exit[1]/this.scale);D.visible=false;this.addChild(D);var M=new Sprite(1,1);M.x=Math.floor(B.start[0]/this.scale);M.y=Math.floor(B.start[1]/this.scale);M.backgroundColor="#ff00ff";this.addChild(M);for(var J=0,K=B.ghosts.length;J<K;J++){var H=new Enemy(3,3,E,M);H.image=N.assets["assets/ghost.png"];H.x=Math.floor(B.ghosts[J][0]/this.scale);H.y=Math.floor(B.ghosts[J][1]/this.scale);this.addChild(H)}var C=new MusicPlayer();C.play("assets/music",true);this.addEventListener(Event.ENTER_FRAME,function(Q){O+=Q.elapsed;if(O>2000){L=Math.min(42,L+1);O-=2000}var P=A.context;P.save();P.globalCompositeOperation="destination-out";P.fillStyle="rgba(0, 0, 0, .1)";P.fillRect(0,0,N.width,N.height);P.restore();var S=M.x;var R=M.y;if(this.accelX!=0){S=Math.min(N.width-1,Math.max(0,S+this.accelX))}if(this.accelY!=0){R=Math.min(N.height-1,Math.max(0,R+this.accelY))}var T=this.mapData[S*this.scale][R*this.scale];if(T>0){M.x=S;M.y=R}E.clear();this._calcLight(M.x,M.y,L,E,A);var T=E.getPixel(D.x,D.y);if(T[0]>0){D.visible=true;if(Math.abs(M.x-D.x-1)<=1&&Math.abs(M.y-D.y-1)<=1){this.clearEventListener(Event.ENTER_FRAME);if(ghosts.levelindex+1==ghosts.leveldata.length){N.replaceScene(new EndScene())}else{N.replaceScene(new WellDoneScene())}}}else{D.visible=false}});this.addEventListener(Event.EXIT,function(){C.stop();this.clearEventListener(Event.UP_BUTTON_DOWN);this.clearEventListener(Event.DOWN_BUTTON_DOWN);this.clearEventListener(Event.LEFT_BUTTON_DOWN);this.clearEventListener(Event.RIGHT_BUTTON_DOWN);this.clearEventListener(Event.UP_BUTTON_UP);this.clearEventListener(Event.DOWN_BUTTON_UP);this.clearEventListener(Event.LEFT_BUTTON_UP);this.clearEventListener(Event.RIGHT_BUTTON_UP);for(var P in this.childNodes){this.removeChild(this.childNodes[P])}})},_buildMapData:function(D){this.mapData=[];var H=Core.instance.assets[ghosts.leveldata[D].name];var F=1/ghosts.leveldata[D].data.scale;var A=new Surface(H.width,H.height);A.draw(H);var C=A.context.getImageData(0,0,A.width,A.height);for(var I=0;I<C.width;I++){this.mapData.push([]);for(var G=0;G<C.height;G++){var B=(G*C.width+I)*4;var E=((C.data[B]<<16)|(C.data[B+1]<<8)|(C.data[B+2]))*F;this.mapData[I][G]=E}}this.scale=C.width/Core.instance.width},_bindInputListeners:function(){this.addEventListener(Event.UP_BUTTON_DOWN,function(){this.accelY=-1});this.addEventListener(Event.DOWN_BUTTON_DOWN,function(){this.accelY=1});this.addEventListener(Event.LEFT_BUTTON_DOWN,function(){this.accelX=-1});this.addEventListener(Event.RIGHT_BUTTON_DOWN,function(){this.accelX=1});this.addEventListener(Event.UP_BUTTON_UP,function(){this.accelY=0});this.addEventListener(Event.DOWN_BUTTON_UP,function(){this.accelY=0});this.addEventListener(Event.LEFT_BUTTON_UP,function(){this.accelX=0});this.addEventListener(Event.RIGHT_BUTTON_UP,function(){this.accelX=0})},_calcLight:function(M,L,R,f,d){var W=Math.max(0,M-R);var B=Math.max(0,L-R);var U=Math.min(f.width,M+R);var A=Math.min(f.height,L+R);var e=this.mapData;var J=R*R;var T=f.context.getImageData(0,0,f.width,f.height);var Q=this.scale;var D=0;for(var V=B;V<A;++V){for(var O=W;O<U;++O){var F=O-M;var C=V-L;if(F*F+C*C>J){continue}var X=e[O*Q][V*Q];if((O==M&&V==L)){D=(V*T.width+O)*4;T.data[D]=255;T.data[D+1]=255;T.data[D+2]=255;T.data[D+3]=255;continue}var G=(M-O)*Q;var E=(L-V)*Q;var S=G*G+E*E;var K=Math.sqrt(S);G/=K;E/=K;var H=0;var I=X==0?3*Q:X;var b=O*Q;var Y=V*Q;do{if(I==0){break}H=I;b+=H*G;Y+=H*E;var P=b-O*Q;var N=Y-V*Q;if(P*P+N*N>S){D=(V*T.width+O)*4;var Z=1-(1/R*(K/Q));if(X==0){d.setPixel(O,V,127,127,127,255)}T.data[D]=255;T.data[D+1]=255;T.data[D+2]=255;T.data[D+3]=Z*255;break}I=e[Math.round(b)][Math.round(Y)]}while(H>0)}}f.context.putImageData(T,0,0)}});var IntroScene=enchant.Class.create(enchant.Scene,{initialize:function(){Scene.call(this);var B=Core.instance;var D=new Sprite(B.width,B.height);ghosts.attempts=1;ghosts.levelindex=0;var E=["assets/intro-1.png","assets/intro-2.png","assets/intro-3.png"];var A=0;D.image=B.assets[E[A]];this.addChild(D);var C=0;this.addEventListener(Event.ENTER_FRAME,function(F){C+=F.elapsed;if(C>=4000){A=(A+1)%E.length;D.image=B.assets[E[A]];C-=4000}});B.addEventListener(Event.INPUT_START,function(F){B.clearEventListener(Event.INPUT_START);this.clearEventListener(Event.ENTER_FRAME);B.replaceScene(new GameScene())})}});var WellDoneScene=enchant.Class.create(enchant.Scene,{initialize:function(){Scene.call(this);var A=Core.instance;var B=new Sprite(A.width,A.height);B.image=A.assets["assets/welldone.png"];this.addChild(B);ghosts.levelindex++;this.addEventListener(Event.INPUT_START,function(C){this.clearEventListener(Event.INPUT_START);A.replaceScene(new GameScene())})}});var EndScene=enchant.Class.create(enchant.Scene,{initialize:function(){Scene.call(this);var K=Core.instance;var F=new Sprite(K.width,K.height);F.image=K.assets["assets/end.png"];this.addChild(F);var D=69;var B=29;var I=ghosts.attempts.toString();for(var G=0,H=I.length;G<H;G++){var E=I.charAt(G);var C=new Sprite(5,5);C.image=K.assets["assets/numbers.png"];C.frame=parseInt(E);C.x=D;C.y=B;D+=6;this.addChild(C)}var A=["assets/end.png","assets/end-2.png"];var J=0;var L=0;this.addEventListener(Event.ENTER_FRAME,function(M){L+=M.elapsed;if(L>=4000){J=(J+1)%A.length;F.image=K.assets[A[J]];L-=4000}});this.addEventListener(Event.INPUT_START,function(M){this.clearEventListener(Event.INPUT_START);this.clearEventListener(Event.ENTER_FRAME);K.replaceScene(new IntroScene())})}});if(ghosts.useOgg){ghosts.assets.push("assets/music.ogg","assets/scream.ogg")}else{ghosts.assets.push("assets/music.mp3","assets/scream.mp3")}var MusicPlayer=enchant.Class.create({_music:null,_repeatInterval:null,initialize:function(){this._music=null;return this},play:function(C,A){this.stop();var B=C+(ghosts.useOgg?".ogg":".mp3");if(B in Core.instance.assets){this._music=Core.instance.assets[B];this._music.play();var E=this._music.duration;if(!E&&this._music.buffer){E=this._music.buffer.duration}if(A&&E>0){var D=this._music;this._repeatInterval=window.setInterval(function(){D.stop();D.play()},Math.round(E*1000))}}return this},stop:function(){window.clearInterval(this._repeatInterval);if(this._music){this._music.stop()}return this},asset:{get:function(){return this._music||{volume:0,play:function(){},stop:function(){}}}}});var ldata=ghosts.leveldata||[];ldata.push({name:"assets/levelmap/level-01.png",data:{start:[10,119],ghosts:[[66,64],[179,107]],exit:[182,12],scale:140985}});var ldata=ghosts.leveldata||[];ldata.push({name:"assets/levelmap/level-02.png",data:{start:[95,63],ghosts:[[183,10],[120,37],[117,87],[8,119]],exit:[163,63],scale:140985}});var ldata=ghosts.leveldata||[];ldata.push({name:"assets/levelmap/level-03.png",data:{start:[104,64],ghosts:[[31,34],[141,35],[132,116],[96,117]],exit:[22,9],scale:140985}});var ldata=ghosts.leveldata||[];ldata.push({name:"assets/levelmap/level-04.png",data:{start:[155,88],ghosts:[[16,37],[171,61],[37,95],[75,96]],exit:[187,8],scale:140985}});var ldata=ghosts.leveldata||[];ldata.push({name:"assets/levelmap/level-05.png",data:{start:[87,7],ghosts:[[189,8],[47,36],[127,46],[189,92],[84,114]],exit:[169,8],scale:140985}});var ldata=ghosts.leveldata||[];ldata.push({name:"assets/levelmap/level-06.png",data:{start:[50,38],ghosts:[[90,10],[51,53],[136,90],[51,96],[72,120]],exit:[163,88],scale:140985}});var ldata=ghosts.leveldata||[];ldata.push({name:"assets/levelmap/level-07.png",data:{start:[7,16],ghosts:[[29,26],[141,30],[63,33],[50,78],[162,102]],exit:[94,28],scale:140985}});enchant();window.onload=function(){var B=new Core(98,64);B.fps=12;B.scale=1;for(var C=0,A=ghosts.leveldata.length;C<A;C++){ghosts.assets.push(ghosts.leveldata[C].name)}B.preload(ghosts.assets);B.addEventListener(enchant.Event.LOAD,function(){var D=new IntroScene();B.pushScene(D)});B.start();window.scrollTo(0,0)};